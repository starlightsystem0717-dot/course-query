<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ˜Ÿå…‰èª²ç¨‹æŸ¥è©¢ç³»çµ± - å°ˆæ¥­ç‰ˆ</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- å¼•å…¥ Lucide åœ–æ¨™åº« -->
  <script src="https://unpkg.com/lucide@latest"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap');
    
    body { 
      font-family: 'Noto Sans TC', sans-serif; 
      background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%); 
      min-height: 100vh;
      color: #1e293b;
    }

    .glass-card { 
      background: rgba(255, 255, 255, 0.95); 
      backdrop-filter: blur(20px); 
      border: 1px solid rgba(255, 255, 255, 0.5);
    }

    .fade-in { animation: fadeIn 0.6s cubic-bezier(0.16, 1, 0.3, 1); }
    @keyframes fadeIn { 
      from { opacity: 0; transform: translateY(20px); } 
      to { opacity: 1; transform: translateY(0); } 
    }

    /* æ’åºæŒ‰éˆ•æ¨£å¼ */
    .sortable { cursor: pointer; transition: background-color 0.2s; user-select: none; }
    .sortable:hover { background-color: rgba(79, 70, 229, 0.05); }

    /* æ‰‹æ©Ÿç«¯è¡¨æ ¼è½‰å¡ç‰‡ä½ˆå±€ */
    @media (max-width: 768px) {
      .responsive-table thead { display: none; }
      .responsive-table tr { 
        display: block; 
        margin-bottom: 1.5rem; 
        background: white;
        border-radius: 1.5rem;
        box-shadow: 0 4px 20px -1px rgb(0 0 0 / 0.05);
        border: 1px solid #f1f5f9;
        overflow: hidden;
      }
      .responsive-table td { 
        display: flex; 
        justify-content: space-between;
        align-items: center;
        padding: 1rem 1.25rem;
        border-bottom: 1px solid #f8fafc;
      }
      .responsive-table td:last-child { border-bottom: none; }
      .responsive-table td::before {
        content: attr(data-label);
        font-weight: 700;
        color: #64748b;
        font-size: 0.85rem;
      }
    }
  </style>
</head>
<body class="p-4 md:p-12 flex flex-col items-center">

  <!-- ğŸ’¡ è¨­å®šå€åŸŸ -->
  <script>
    // è«‹ç¢ºä¿æ­¤ç¶²å€æ­£ç¢ºç„¡èª¤
    const GAS_API_URL = 'https://script.google.com/macros/s/AKfycbx8GAukuqxOixjgM9UGPwQCPXyuuz0hoJBfVa1qiozBxDMhiz-dvFeW5L9bd7oxRUv1/exec'; 
  </script>

  <!-- ç™»å…¥é©—è­‰å€åŸŸ -->
  <div id="login-section" class="w-full max-w-md glass-card rounded-[2.5rem] shadow-2xl p-8 md:p-12 mt-10 fade-in">
    <div class="text-center mb-10">
      <div class="inline-flex items-center justify-center w-20 h-20 bg-indigo-600 text-white rounded-[1.8rem] shadow-xl shadow-indigo-200 mb-6 transform -rotate-3">
        <i data-lucide="search" class="w-10 h-10"></i>
      </div>
      <h1 class="text-3xl font-black text-slate-800 tracking-tight">å­¸å“¡ç´€éŒ„æŸ¥è©¢</h1>
      <p class="text-slate-500 mt-2 font-medium">Star Course Query System</p>
    </div>

    <div class="space-y-6">
      <div class="relative">
        <label class="block text-sm font-bold text-slate-600 mb-2 ml-1">çœŸå¯¦å§“å</label>
        <div class="relative">
          <i data-lucide="user" class="absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-slate-400"></i>
          <input type="text" id="userName" placeholder="è«‹è¼¸å…¥å§“å" 
                 class="w-full pl-12 pr-5 py-4 rounded-2xl border border-slate-200 focus:ring-4 focus:ring-indigo-100 focus:border-indigo-500 outline-none transition-all placeholder:text-slate-300">
        </div>
      </div>
      
      <div>
        <label class="block text-sm font-bold text-slate-600 mb-2 ml-1">æ‰‹æ©Ÿæœ«ä¸‰ç¢¼</label>
        <div class="relative">
          <i data-lucide="smartphone" class="absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-slate-400"></i>
          <input type="text" id="phoneLastThree" maxlength="3" inputmode="numeric" placeholder="ä¾‹å¦‚ï¼š123" 
                 onkeyup="if(event.key === 'Enter') handleLogin()"
                 class="w-full pl-12 pr-5 py-4 rounded-2xl border border-slate-200 focus:ring-4 focus:ring-indigo-100 focus:border-indigo-500 outline-none transition-all placeholder:text-slate-300">
        </div>
      </div>
      
      <div id="errorMessage" class="hidden bg-rose-50 text-rose-600 p-4 rounded-2xl text-sm text-center font-bold border border-rose-100 fade-in"></div>

      <button onclick="handleLogin()" id="submitBtn" 
              class="w-full bg-slate-900 hover:bg-indigo-700 text-white font-bold py-5 rounded-[1.5rem] shadow-xl transition-all transform active:scale-[0.97] flex justify-center items-center group">
        <span id="btnText">å•Ÿå‹•èº«ä»½é©—è­‰</span>
        <i id="btnIcon" data-lucide="arrow-right" class="ml-2 w-5 h-5 transition-transform group-hover:translate-x-1"></i>
        <div id="loader" class="hidden ml-3 w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
      </button>
    </div>
  </div>

  <!-- æŸ¥è©¢çµæœå€åŸŸ -->
  <div id="result-section" class="hidden w-full max-w-5xl mt-6 fade-in">
    <div class="flex flex-col md:flex-row justify-between items-end md:items-center mb-8 px-4 gap-4">
      <div>
        <h2 class="text-4xl font-black text-slate-800 tracking-tighter">å ±åæ˜ç´°</h2>
        <p id="resultCount" class="text-indigo-600 font-bold text-sm mt-1 uppercase tracking-widest"></p>
      </div>
      <button onclick="location.reload()" class="px-6 py-3 bg-white border border-slate-200 rounded-2xl text-slate-600 hover:bg-slate-50 font-bold shadow-sm transition-all flex items-center">
        <i data-lucide="refresh-cw" class="w-4 h-4 mr-2"></i>
        é‡æ–°æŸ¥è©¢
      </button>
    </div>
    
    <div class="glass-card rounded-[2.5rem] shadow-2xl overflow-hidden border border-white">
      <div class="overflow-x-auto">
        <table class="w-full text-left border-collapse responsive-table">
          <thead>
            <tr class="bg-indigo-600 text-white">
              <th onclick="sortTable('date')" class="sortable px-8 py-6 font-bold text-sm tracking-widest uppercase">
                <div class="flex items-center">
                  èª²ç¨‹æ—¥æœŸ <i id="sort-icon-date" data-lucide="chevrons-up-down" class="ml-2 w-4 h-4 opacity-70"></i>
                </div>
              </th>
              <th onclick="sortTable('course')" class="sortable px-8 py-6 font-bold text-sm tracking-widest uppercase">
                <div class="flex items-center">
                  å ±åèª²ç¨‹ <i id="sort-icon-course" data-lucide="chevrons-up-down" class="ml-2 w-4 h-4 opacity-70"></i>
                </div>
              </th>
              <th onclick="sortTable('status')" class="sortable px-8 py-6 font-bold text-sm tracking-widest uppercase text-center">
                <div class="flex items-center justify-center">
                  å®Œæ¬¾ç‹€æ³ <i id="sort-icon-status" data-lucide="chevrons-up-down" class="ml-2 w-4 h-4 opacity-70"></i>
                </div>
              </th>
            </tr>
          </thead>
          <tbody id="resultBody" class="divide-y divide-slate-100 bg-white/70">
            <!-- è³‡æ–™å‹•æ…‹æ’å…¥ -->
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    // åˆå§‹åŒ– Lucide åœ–æ¨™
    lucide.createIcons();

    let fetchedData = [];
    let currentSort = { key: 'date', direction: 'desc' }; // é è¨­ä¾æ—¥æœŸé™åºæ’åˆ—

    async function handleLogin() {
      const name = document.getElementById('userName').value.trim();
      const lastThree = document.getElementById('phoneLastThree').value.trim();
      const btn = document.getElementById('submitBtn');
      const loader = document.getElementById('loader');
      const btnText = document.getElementById('btnText');
      const btnIcon = document.getElementById('btnIcon');
      const errorMsg = document.getElementById('errorMessage');

      if (!name || !/^\d{3}$/.test(lastThree)) {
        showError('è«‹å®Œæ•´å¡«å¯«å§“åèˆ‡ 3 ä½æœ«ä¸‰ç¢¼');
        return;
      }

      btn.disabled = true;
      loader.classList.remove('hidden');
      btnIcon.classList.add('hidden');
      btnText.innerText = 'æ­£åœ¨è®€å–æ˜Ÿç©ºè³‡æ–™...';
      errorMsg.classList.add('hidden');

      try {
        const url = `${GAS_API_URL}?name=${encodeURIComponent(name)}&lastThree=${lastThree}`;
        const response = await fetch(url);
        const result = await response.json();

        if (result.success && result.data.length > 0) {
          fetchedData = result.data;
          // åˆå§‹æ’åº
          performSort('date', 'desc');
          showResults(name);
        } else {
          showError(result.msg || 'æŸ¥ç„¡ç›¸é—œç´€éŒ„ï¼Œè«‹é‡æ–°ç¢ºèªè³‡è¨Š');
        }
      } catch (err) {
        showError('é€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥ API è¨­å®šæˆ–ç¨å¾Œå†è©¦');
      } finally {
        btn.disabled = false;
        loader.classList.add('hidden');
        btnIcon.classList.remove('hidden');
        btnText.innerText = 'å•Ÿå‹•èº«ä»½é©—è­‰';
      }
    }

    // æ’åºæ ¸å¿ƒé‚è¼¯
    function sortTable(key) {
      const direction = (currentSort.key === key && currentSort.direction === 'asc') ? 'desc' : 'asc';
      performSort(key, direction);
      renderTable();
      updateSortIcons(key, direction);
    }

    function performSort(key, direction) {
      currentSort = { key, direction };
      fetchedData.sort((a, b) => {
        let valA = a[key];
        let valB = b[key];

        // å¦‚æœæ˜¯æ—¥æœŸï¼Œè½‰æ›ç‚º Date ç‰©ä»¶æ¯”è¼ƒ
        if (key === 'date') {
          valA = new Date(valA);
          valB = new Date(valB);
        }

        if (valA < valB) return direction === 'asc' ? -1 : 1;
        if (valA > valB) return direction === 'asc' ? 1 : -1;
        return 0;
      });
    }

    function renderTable() {
      const tbody = document.getElementById('resultBody');
      tbody.innerHTML = fetchedData.map(item => {
        const statusText = item.status || 'è™•ç†ä¸­';
        let statusClass = 'bg-slate-100 text-slate-600 ring-1 ring-slate-200';
        
        if (statusText === 'å·²å®Œæ¬¾') {
          statusClass = 'bg-green-100 text-green-700 ring-1 ring-green-600/20';
        } else if (statusText.includes('-') || statusText.toLowerCase().includes('pay') || statusText.includes('/')) {
          statusClass = 'bg-indigo-100 text-indigo-700 ring-1 ring-indigo-600/20';
        } else if (statusText.includes('å¾…')) {
          statusClass = 'bg-amber-100 text-amber-700 ring-1 ring-amber-600/20';
        }
        
        return `
          <tr class="hover:bg-indigo-50/50 transition-colors group">
            <td data-label="èª²ç¨‹æ—¥æœŸ" class="px-8 py-6 text-sm text-slate-500 font-medium whitespace-nowrap">${item.date}</td>
            <td data-label="å ±åèª²ç¨‹" class="px-8 py-6 text-sm text-slate-800 font-bold group-hover:text-indigo-600 transition-colors">${item.course}</td>
            <td data-label="å®Œæ¬¾ç‹€æ³" class="px-8 py-6 text-sm text-center">
              <span class="inline-flex items-center px-4 py-1.5 rounded-full text-xs font-black tracking-wider ${statusClass}">
                ${statusText}
              </span>
            </td>
          </tr>
        `;
      }).join('');
    }

    function updateSortIcons(activeKey, direction) {
      const keys = ['date', 'course', 'status'];
      keys.forEach(key => {
        const icon = document.getElementById(`sort-icon-${key}`);
        if (key === activeKey) {
          icon.setAttribute('data-lucide', direction === 'asc' ? 'chevron-up' : 'chevron-down');
          icon.classList.remove('opacity-70');
          icon.classList.add('opacity-100');
        } else {
          icon.setAttribute('data-lucide', 'chevrons-up-down');
          icon.classList.add('opacity-70');
        }
      });
      lucide.createIcons(); // é‡æ–°æ¸²æŸ“åœ–æ¨™
    }

    function showResults(name) {
      document.getElementById('login-section').classList.add('hidden');
      document.getElementById('result-section').classList.remove('hidden');
      const countLabel = document.getElementById('resultCount');
      countLabel.innerText = `${name} æ‚¨å¥½ï¼Œç›®å‰å…±æœ‰ ${fetchedData.length} ç­†èª²ç¨‹ç´€éŒ„`;
      renderTable();
      updateSortIcons(currentSort.key, currentSort.direction);
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function showError(msg) {
      const errorMsg = document.getElementById('errorMessage');
      errorMsg.innerText = msg;
      errorMsg.classList.remove('hidden');
      const section = document.getElementById('login-section');
      section.classList.add('translate-x-1');
      setTimeout(() => section.classList.remove('translate-x-1'), 100);
    }
  </script>
</body>
</html>
